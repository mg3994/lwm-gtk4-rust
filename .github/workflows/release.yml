name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  pull-requests: read

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-rust

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release
      shell: msys2 {0}
      run: |
        export PATH="/mingw64/bin:$PATH"
        cargo build --release

    - name: Create release bundle
      shell: msys2 {0}
      run: |
        # Create release bundle directory
        mkdir -p release-bundle
        
        # Copy main executable and resources
        cp target/release/linkwithmentor.exe release-bundle/
        cp -r resources release-bundle/
        cp README.md release-bundle/
        cp INSTALLATION.md release-bundle/
        cp LICENSE release-bundle/ 2>/dev/null || true
        
        # Find and copy GTK4 DLLs using ldd to get actual dependencies
        echo "Finding GTK4 dependencies..."
        ldd target/release/linkwithmentor.exe | grep -E "(gtk|glib|gobject|gio|gdk|pango|cairo)" | awk '{print $3}' | while read dll; do
          if [ -f "$dll" ]; then
            cp "$dll" release-bundle/
            echo "✓ Copied dependency: $(basename $dll)"
          fi
        done
        
        # Copy additional GTK4 runtime DLLs that might not show in ldd
        # GTK4 uses -4-1.dll, GLib family uses -2.0-0.dll
        for pattern in libgtk-4-1.dll libgdk-4-1.dll libglib-2.0-0.dll libgobject-2.0-0.dll libgio-2.0-0.dll libgmodule-2.0-0.dll libcairo-2.dll libcairo-gobject-2.dll libpango-1.0-0.dll libpangocairo-1.0-0.dll libpangowin32-1.0-0.dll libgdk_pixbuf-2.0-0.dll libharfbuzz-0.dll libfontconfig-1.dll libfreetype-6.dll libpng16-16.dll libintl-8.dll libiconv-2.dll libpcre2-8-0.dll libffi-8.dll zlib1.dll libwinpthread-1.dll libgcc_s_seh-1.dll libstdc++-6.dll libbz2-1.dll libexpat-1.dll libepoxy-0.dll libfribidi-0.dll libgraphene-1.0-0.dll; do
          if [ -f "/mingw64/bin/$pattern" ]; then
            cp "/mingw64/bin/$pattern" release-bundle/
            echo "✓ Copied: $pattern"
          else
            echo "⚠ Missing: $pattern"
          fi
        done
        
        # Copy GTK4 data files
        if [ -d "/mingw64/share/glib-2.0/schemas" ]; then
          mkdir -p release-bundle/share/glib-2.0
          cp -r /mingw64/share/glib-2.0/schemas release-bundle/share/glib-2.0/
          echo "Copied GTK schemas"
        fi
        
        # Copy additional GTK4 data
        if [ -d "/mingw64/share/gtk-4.0" ]; then
          mkdir -p release-bundle/share
          cp -r /mingw64/share/gtk-4.0 release-bundle/share/
          echo "Copied GTK4 data"
        fi
        
        # List what we copied
        echo "Release bundle contents:"
        ls -la release-bundle/
        echo "DLL count: $(ls release-bundle/*.dll 2>/dev/null | wc -l)"

    - name: Create launcher and finalize bundle
      shell: pwsh
      run: |
        # Create a simple launcher script
        $launcherScript = '@echo off' + "`n" + 'set GTK_THEME=win32' + "`n" + 'set GSETTINGS_SCHEMA_DIR=%~dp0share\glib-2.0\schemas' + "`n" + '"%~dp0linkwithmentor.exe" %*'
        $launcherScript | Out-File -FilePath "release-bundle/LinkWithMentor.bat" -Encoding ASCII
        
        # Verify critical files exist
        $criticalFiles = @("linkwithmentor.exe", "LinkWithMentor.bat")
        foreach ($file in $criticalFiles) {
          $filePath = Join-Path "release-bundle" $file
          if (-not (Test-Path $filePath)) {
            Write-Error "CRITICAL: $file is missing from bundle!"
            exit 1
          } else {
            Write-Host "✓ Verified: $file is in bundle"
          }
        }
        
        Write-Host "Bundle creation completed successfully"

    - name: Install NSIS
      shell: pwsh
      run: |
        # Install NSIS using Chocolatey (pre-installed on GitHub Actions)
        choco install nsis -y
        
        # Refresh environment variables
        refreshenv
        
        # Verify NSIS installation
        if (Test-Path "C:\Program Files (x86)\NSIS\makensis.exe") {
          Write-Host "✓ NSIS installed successfully"
        } else {
          Write-Error "NSIS installation failed"
          exit 1
        }

    - name: Create Installer
      shell: pwsh
      run: |
        # Find NSIS makensis.exe
        $nsisPath = @(
          "C:\Program Files (x86)\NSIS\makensis.exe",
          "C:\Program Files\NSIS\makensis.exe",
          "C:\ProgramData\chocolatey\lib\nsis\tools\makensis.exe"
        ) | Where-Object { Test-Path $_ } | Select-Object -First 1
        
        if (-not $nsisPath) {
          Write-Error "NSIS makensis.exe not found"
          exit 1
        }
        
        Write-Host "Using NSIS at: $nsisPath"
        
        # Build the NSIS installer
        & $nsisPath installer.nsi
        
        # Verify installer was created
        if (Test-Path "LinkWithMentor-Setup.exe") {
          Write-Host "✓ Installer created successfully"
          $size = (Get-Item "LinkWithMentor-Setup.exe").Length / 1MB
          Write-Host "Installer size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "Failed to create installer"
          exit 1
        }

    - name: Create ZIP archive (fallback)
      shell: pwsh
      run: |
        Compress-Archive -Path release-bundle/* -DestinationPath LinkWithMentor-Windows-x64.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          LinkWithMentor-Setup.exe
          LinkWithMentor-Windows-x64.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}
